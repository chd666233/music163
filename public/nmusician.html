<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/nmusician.css">
  <link rel="stylesheet" href="css/nmusician_index.css">

</head>
<body class="nmusician">
  <header id="header">
    <nav>
      <a href="#" class="logo">网易音乐人</a>
      <ul class="page">
        <li class="active"><a href="#">首页</a></li>
        <li><a href="#" class="z-stone-plan-online">石头计划</a></li>
        <li><a href="#">个人中心</a></li>
        <li><a href="#">常见问题</a></li>
      </ul>
    
      <ul class="user">
        <li><a href="#" class="joinUs">加入音乐人</a></li>
        <li>您还未登陆，请先<a href="#" class="login">登陆</a></li>
      </ul>
    </nav>
  </header>
  <!-- <iframe name="contentFrame" src="nmusician_index.html" frameborder="0" scrolling="no"></iframe> -->

  <section>
    <ul id="floor">
      <li class="floor1">
        <img src="img/nmusician_1.png" alt="">
        <p class="joinUs">
          <a href="#">现在加入</a>
          <a href="#">I'm Not Chinese Artist ></a>
        </p>
        <div class="btn">
          <a href="#"></a>
          <a href="#"></a>
          <a href="#"></a>
        </div>
      </li>
      <li class="floor2">
        <img src="img/nmusician_1.png" alt="">
      </li>
      <li class="floor3">
        <img src="img/nmusician_1.png" alt="">
      </li>
      <li class="floor4">
        <img src="img/nmusician_1.png" alt="">
      </li>
    </ul>
    <ul id="indicator" class="indicator"></ul>
  </section>
  <script>
  "use strict";
  (function(){
    // 判断浏览器类型
    var isMacWebkit=(navigator.userAgent.indexOf("Macintosh")!==-1&&navigator.userAgent.indexOf("WebKit")!==-1);
    var isFirefox=(navigator.userAgent.indexOf("Gecko")!==-1);
    //获取需要的节点
    var header=document.getElementById("header");
    var floor=document.getElementById("floor");
    var indicator=document.getElementById("indicator");
    var fragment=document.createDocumentFragment();
    var length=floor.getElementsByTagName("LI").length;
    var viewH=innerHeight;

    //动态添加指示器
    for(var i=0;i<length;i++){
      var li=document.createElement("LI");
      if(i==0) li.className="active";
      li.setAttribute("data-index",i);
      fragment.appendChild(li);
    }
    indicator.appendChild(fragment);
    var lis=indicator.getElementsByTagName("LI");
    
    //注册事件处理函数
    floor.onwheel=wheelHandler;//FF未来浏览器
    floor.onmousewheel=wheelHandler//大多数当前浏览器
    if(isFirefox)//仅FireFox，包括FF未来
      floor.addEventListener("DOMMouseScroll",wheelHandler,false);


    //初始化事件处理函数参数
    var targetT=0,scrolling,isScroll=true,overing,isOver=false,overing2,index=0;
    indicator.onmouseover=mOverHandler;
    indicator.onmouseout=function(event){
      clearTimeout(overing2);
    }
    function mOverHandler(event){
      var e=event || window.event;//标准或IE事件对象
      if(e.target.nodeName!=='LI') return;

      
      // console.log("++++++++",index,targetT,ulT)
      // if(isScroll) return;
  
      var time=0;
      //如果上一轮还没有滚动到目标位置，延迟滚动
      var ulT=parseFloat(getComputedStyle(floor).top);
      if(targetT!=ulT){
        time=700;
      }
      if(overing2) clearTimeout(overing2);
      overing2=setTimeout(()=>{
        // isOver=true;
        var currenteInde=index;
        index=[].indexOf.call(lis,e.target);
        lis[currenteInde].className="";
        lis[index].className="active";
        targetT=ulT=-index*viewH;
        floor.style.cssText=`transition:top 1s ease-in-out;top:${ulT}px`;
        //如果移动间隔1ms结束锁定，可以滚动，避免数据错乱
        if(overing) clearTimeout(overing);
        overing=setTimeout(()=>{
          floor.style.cssText=`transition:none;top:${ulT}px`;
          // isOver=false;
          indicator.onmouseover=mOverHandler;
        },1000)
      },time);
    }

    //事件处理函数
    function wheelHandler(event){
      // console.log("-------------",index)
      var ulT=parseFloat(getComputedStyle(floor).top);
      var ulH=parseFloat(getComputedStyle(floor).height)*length;
      isScroll=true;
      //如果上一轮还没有滚动到目标位置，不执行这轮滚动
      if(targetT!=ulT)return;
      // if(isOver)return;

      
      //计算跨浏览器的deltaY
      var e=event || window.event;//标准或IE事件对象
      var deltaY=(e.deltaY!==null&&e.deltaY*-30)||//3级
                (e.wheelDelta!==null&&e.wheelDelta/4)||//大部份浏览器
                e.detail*-10||//FF
                0;//未定义
      if(isMacWebkit){//如果是Mac,delta的值大120倍
        deltaY/=30;
      }

      //如果事件类型不是DOMMouseScroll就不再需要,因为如果FF未来版支持wheel或mousewheel会重复添加事件，需要去掉重复事件
      if(isFirefox && e.type!=="DOMMouseScroll")
        floor.removeEventListener("DOMMouseScroll",wheelHandler,false);

      
      if(deltaY>0){
        if(index==0)return;
        if(index==1)header.style.cssText="transition:background 1s;background:rgba(36, 36, 36, 0)";
        //滚动
        index--;
        lis[index].className="active";
        lis[index+1].className="";
        
      }else{
        if(index==length-1) return;
        header.style.cssText="transition:background 1s;background:rgb(36, 36, 36)";
        //滚动
        index++;
        lis[index].className="active";
        lis[index-1].className="";
      }
      targetT=ulT=-viewH*index;
      floor.style.cssText=`transition:top 1s ease-in-out;top:${ulT}px`;

      //鼠标停止滚动，取消渐变
      if(scrolling) clearTimeout(scrolling);
      scrolling=setTimeout(()=>{
        floor.style.cssText=`transition:none;top:${ulT}px`;
        // isScroll=false;
      },1000)

      //调用wheel事件上的preventDefault(),也能阻止mousewheel事件的产生
      if(e.preventDefault)e.preventDefault();
      if(e.stopPropagation)e.stopPropagation();
      e.cancelBubble=true;//IE事件  阻止冒泡
      e.returnValue=false;//IE事件
      return false;
    }
 
  })()
  
 
  </script>
</body>
</html>